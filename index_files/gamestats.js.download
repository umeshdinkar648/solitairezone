function postToBackend(params,callback){var gatewayUrl="//backend.spiele-palast.de/gateway_js.php";var posting=jQuery.post(gatewayUrl,{json:JSON.stringify(params)},'text');posting.done(callback)}
var STATS_LANG={"de":{"NUMERIC_MARK":".","CHAMPION_DAILY":"Tagessieger","CHAMPION_MONTHLY":"Monatsbester","CHAMPION_QUARTERLY":"Quartals-Meister","NEWEST_MEMBER":"Unser neustes Mitglied","BEST_ROUND":"Beste Runde","MOST_WINS":"Meiste Siege","BEST_SCORE":"Aktuell bester Schnitt","POINTS_IN":"Punkte in","CHIPS_IN":"Chips in","ROUNDS":"Runden","NEWEST_MEMBER_DETAILS":"Herzlich Willkommen!","BEST_ROUND_DETAILS":"Punkte (letzte Stunde)","MOST_WINS_DETAILS":"Siege (letzte Stunde)","TITLE":"Titel","AVATAR":"Avatar","NAME":"Name","DETAILS":"Details","RANK":"Rang","SCORE":"Punkte","ROUNDS_PLAYED":"Runden gespielt"},"en":{"NUMERIC_MARK":",","CHAMPION_DAILY":"Best of the Day","CHAMPION_MONTHLY":"Best of the Month","CHAMPION_QUARTERLY":"Quarter Champion","NEWEST_MEMBER":"Our newest Member","BEST_ROUND":"Best Round","MOST_WINS":"Most Wins","BEST_SCORE":"Currently best Mean","POINTS_IN":"Points in","CHIPS_IN":"Chips in","ROUNDS":"rounds","NEWEST_MEMBER_DETAILS":"A heartfelt Welcome!","BEST_ROUND_DETAILS":"Points (last hour)","MOST_WINS_DETAILS":"Wins (last hour)","TITLE":"Title","AVATAR":"Avatar","NAME":"Name","DETAILS":"Details","RANK":"Rank","SCORE":"Score","ROUNDS_PLAYED":"Rounds played"},"fr":{"NUMERIC_MARK":",","CHAMPION_DAILY":"Top du jour","CHAMPION_MONTHLY":"Top du mois","CHAMPION_QUARTERLY":"Champion Rami","NEWEST_MEMBER":"Notre dernier membre","BEST_ROUND":"Meilleure manche","MOST_WINS":"Record de victoires","BEST_SCORE":"Meilleure moyenne actuelle","POINTS_IN":"points en","CHIPS_IN":"Jetons au","ROUNDS":"manches","NEWEST_MEMBER_DETAILS":"Souhaitons-lui la bienvenue!","BEST_ROUND_DETAILS":"points (dernière heure)","MOST_WINS_DETAILS":"Victoires (dernière heure)","TITLE":"Titre","AVATAR":"Avatar","NAME":"Nom","DETAILS":"Détails","RANK":"Rang","SCORE":"Score","ROUNDS_PLAYED":"Manches jouées"},"it":{"NUMERIC_MARK":",","CHAMPION_DAILY":"Migliore del giorno","CHAMPION_MONTHLY":"Migliore del mese","CHAMPION_QUARTERLY":"Campione di Ramino","NEWEST_MEMBER":"Il membro più recente","BEST_ROUND":"Migliore manche","MOST_WINS":"Record di vittorie","BEST_SCORE":"Media migliore attuale","POINTS_IN":"punti in","CHIPS_IN":"Chip nel","ROUNDS":"manche","NEWEST_MEMBER_DETAILS":"Un benvenuto di cuore!","BEST_ROUND_DETAILS":"punti (ultima ora)","MOST_WINS_DETAILS":"vittorie (ultima ora)","TITLE":"Titolo","AVATAR":"Avatar","NAME":"Nome","DETAILS":"Dettagli","RANK":"Rango","SCORE":"Punteggio","ROUNDS_PLAYED":"Manche giocate"},"es":{"NUMERIC_MARK":",","CHAMPION_DAILY":"Mejor del día","CHAMPION_MONTHLY":"Mejor del mes","CHAMPION_QUARTERLY":"Campeón de Rummy","NEWEST_MEMBER":"Miembro más reciente","BEST_ROUND":"Mejor ronda","MOST_WINS":"Más victorias","BEST_SCORE":"Mejor media actual","POINTS_IN":"puntos en","CHIPS_IN":"Fichas en","ROUNDS":"rondas","NEWEST_MEMBER_DETAILS":"¡Una cálida bienvenida!","BEST_ROUND_DETAILS":"puntos (última hora)","MOST_WINS_DETAILS":"victorias (última hora)","TITLE":"Título","AVATAR":"Avatar","NAME":"Nombre","DETAILS":"Detalles","RANK":"Rango","SCORE":"Puntos","ROUNDS_PLAYED":"Rondas jugadas"},"pl":{"NUMERIC_MARK":",","CHAMPION_DAILY":"Gracz dnia","CHAMPION_MONTHLY":"Gracz miesiąca","CHAMPION_QUARTERLY":"Mistrz remika","NEWEST_MEMBER":"Najnowszy gracz","BEST_ROUND":"Najlepsza runda","MOST_WINS":"Najwięcej wygranych","BEST_SCORE":"Najlepsza średnia","POINTS_IN":"pkt. w","CHIPS_IN":" żet. w","ROUNDS":"rundach","NEWEST_MEMBER_DETAILS":"Serdecznie witamy!","BEST_ROUND_DETAILS":"pkt. (ostatnia godzina)","MOST_WINS_DETAILS":"Wygrane (ostatnia godzina)","TITLE":"Tytuł","AVATAR":"Awatar","NAME":"Nazwa","DETAILS":"Szczegóły","RANK":"Pozycja","SCORE":"Punkty","ROUNDS_PLAYED":"Rozegrane rundy"},"ru":{"NUMERIC_MARK":",","CHAMPION_DAILY":"Чемпион дня","CHAMPION_MONTHLY":"Чемпион месяца","CHAMPION_QUARTERLY":"Чемпион рамми","NEWEST_MEMBER":"Новый участник","BEST_ROUND":"Лучший раунд","MOST_WINS":"Больше всего побед","BEST_SCORE":"Лучш. средний результат (текущ.)","POINTS_IN":"очк. в","CHIPS_IN":"фиш. в","ROUNDS":"раундах","NEWEST_MEMBER_DETAILS":"Сердечно приветствуем!","BEST_ROUND_DETAILS":"очк. (посл. час)","MOST_WINS_DETAILS":"побед(ы) (посл. час)","TITLE":"Звание","AVATAR":"Аватар","NAME":"Имя","DETAILS":"Подробности","RANK":"Ранг","SCORE":"Счет","ROUNDS_PLAYED":"Сыграно раундов"},};var palastStatsLang="de";var statsCallback;function loadLiveStats(gameId,callback,lang="de"){palastStatsLang=lang;var data={action:"league/get_live_stats",gameId:gameId};statsCallback=callback;postToBackend(data,function(text){liveStatsReady(text,gameId)})}
var championsCallback;function loadChampions(gameId,callback,lang="de"){palastStatsLang=lang;var data={action:"league/get_champions",gameId:gameId};championsCallback=callback;postToBackend(data,function(text){championsReady(text,gameId)})}
var leagueCallback;function loadLeague(gameId,page,itemsPerPage,mode,callback,lang="de"){palastStatsLang=lang;var data={action:"league/get_page",page:page,itemsPerPage:itemsPerPage,mode:mode,gameId:gameId};leagueCallback=callback;postToBackend(data,function(text){leagueReady(text,gameId)})}
function leagueReady(text,gameId){var data=JSON.parse(text);var stats=[];for(var i=0;i<data.content.length;++i){var uid=data.content[i].uid;var title="#"+data.content[i].rank;var nickname=decodeDisplayName(data.content[i].displayName);var avatar=getAvatarImage(uid,gameId);var score=numericToDisplayString(data.content[i].score);var rounds=numericToDisplayString(data.content[i].rounds);stats.push({uid:uid,title:title,nickname:nickname,avatar:avatar,score:score,rounds:rounds})}
leagueCallback(stats)}
function championsReady(text,gameId){var data=JSON.parse(text);var stats=[];for(var i=0;i<data.champions.length;++i){if(data.champions[i]==!1)continue;if(i>2)break;var uid=data.champions[i].uid;var title=getChampionsTitleFromIndex(i);var nickname=decodeDisplayName(data.champions[i].displayName);var avatar=getAvatarImage(uid,gameId);var subline=getChampionsSublineFromIndex(i,data.champions[i]);stats.push({uid:uid,title:title,nickname:nickname,avatar:avatar,subline:subline})}
championsCallback(stats)}
function liveStatsReady(text,gameId){var data=JSON.parse(text);var stats=[];for(var i=0;i<data.stats.length;++i){if(data.stats[i]==!1)continue;var uid=data.stats[i].uid;var title=getStatsTitleFromIndex(i);var nickname=sanitizeString(data.stats[i].displayName);var avatar=getAvatarImage(uid,gameId);var subline=getStatsSublineFromIndex(i,data.stats[i]);stats.push({uid:uid,title:title,nickname:nickname,avatar:avatar,subline:subline})}
statsCallback(stats)}
function getChampionsTitleFromIndex(i){switch(i){case 0:return STATS_LANG[palastStatsLang].CHAMPION_DAILY;case 1:return STATS_LANG[palastStatsLang].CHAMPION_MONTHLY;case 2:return STATS_LANG[palastStatsLang].CHAMPION_QUARTERLY}
return""}
function getChampionsSublineFromIndex(i,data){if(i==1){return numericToDisplayString(data.score)+" "+STATS_LANG[palastStatsLang].CHIPS_IN+" "+numericToDisplayString(data.rounds)+" "+STATS_LANG[palastStatsLang].ROUNDS}else{return numericToDisplayString(data.score)+" "+STATS_LANG[palastStatsLang].POINTS_IN+" "+numericToDisplayString(data.rounds)+" "+STATS_LANG[palastStatsLang].ROUNDS}}
function getStatsTitleFromIndex(i){switch(i){case 0:return STATS_LANG[palastStatsLang].NEWEST_MEMBER;case 1:return STATS_LANG[palastStatsLang].BEST_ROUND;case 2:return STATS_LANG[palastStatsLang].MOST_WINS;case 3:return STATS_LANG[palastStatsLang].BEST_SCORE}
return""}
function getStatsSublineFromIndex(i,data){switch(i){case 0:return STATS_LANG[palastStatsLang].NEWEST_MEMBER_DETAILS;case 1:return numericToDisplayString(data.score)+" "+STATS_LANG[palastStatsLang].BEST_ROUND_DETAILS;case 2:return numericToDisplayString(data.wins)+" "+STATS_LANG[palastStatsLang].MOST_WINS_DETAILS;case 3:return numericToDisplayString(Math.round(data.score))+" "+STATS_LANG[palastStatsLang].POINTS_IN+" "+numericToDisplayString(data.rounds)+" "+STATS_LANG[palastStatsLang].ROUNDS}
return""}
function sanitizeString(str){return str.replace(/</g,"&lt;").replace(/>/g,"&gt;")}
function decodeDisplayName(encoded){return sanitizeString(decodeURIComponent(escape(atob(encoded))))}
function getAvatarImage(uid,gameId){var url="//avatars.spiele-palast.de/avatar_get.php?gameId="+gameId+"&uid="+uid+"&size=64";return"<img src='"+url+"'/>"}
function numericToDisplayString(value){var mark=STATS_LANG[palastStatsLang].NUMERIC_MARK;var v=String(value);var count=v.length;var i=count-3;while(i>0){if(v.charAt(i-1)!="-"){v=v.substring(0,i)+mark+v.substring(i)}
i-=3}
return v}
var LiveStatsHandler={tableSelector:'none',gameId:0,initLiveStats:function(tableId,gameId,lang='de'){console.log("init");this.tableSelector='#'+tableId;this.gameId=gameId;loadLiveStats(gameId,this.parseLiveStats.bind(this),lang)},getLiveStatsTableRowTemplate:function(){return'<div class="tr"><div class="td">___title___</div><div class="td">___avatar___</div><div class="td">___name___</div><div class="td stats-not-mobile">___details___</div></div>'},getLiveStatsTableHeadTemplate:function(){return'<div class="tr"><div class="th">___title___</div><div class="th">___avatar___</div><div class="th">___name___</div><div class="th stats-not-mobile">___details___</div></div>'},parseLiveStats:function(stats){var table=jQuery(this.tableSelector);var headerTpl=this.getLiveStatsTableHeadTemplate();headerTpl=headerTpl.split('___title___').join(STATS_LANG[palastStatsLang].TITLE);headerTpl=headerTpl.split('___avatar___').join(STATS_LANG[palastStatsLang].AVATAR);headerTpl=headerTpl.split('___name___').join(STATS_LANG[palastStatsLang].NAME);headerTpl=headerTpl.split('___details___').join(STATS_LANG[palastStatsLang].DETAILS);table.append(jQuery(headerTpl));for(var i=0;i<stats.length;++i){var tpl=this.getLiveStatsTableRowTemplate();tpl=tpl.split('___title___').join(stats[i].title);tpl=tpl.split('___avatar___').join(stats[i].avatar);tpl=tpl.split('___name___').join(stats[i].nickname);tpl=tpl.split('___details___').join(stats[i].subline);table.append(jQuery(tpl))}}}
var LeagueStatsHandler={tableSelector:'none',gameId:0,initLeagueStats:function(tableId,gameId,lang='de'){this.tableSelector='#'+tableId;this.gameId=gameId;loadLeague(gameId,0,10,5,this.parseLeagueStats.bind(this),lang)},getLeagueStatsTableRowTemplate:function(){return'<div class="tr"><div class="td">___rank___</div><div class="td">___avatar___</div><div class="td">___name___</div><div class="td stats-not-mobile">___score___</div><div class="td stats-not-mobile">___roundsPlayed___</div></div>'},getLeagueStatsTableHeadTemplate:function(){return'<div class="tr"><div class="th">___rank___</div><div class="th">___avatar___</div><div class="th">___name___</div><div class="th stats-not-mobile">___score___</div><div class="th stats-not-mobile">___roundsPlayed___</div></div>'},parseLeagueStats:function(stats){var table=jQuery(this.tableSelector);var headerTpl=this.getLeagueStatsTableHeadTemplate();headerTpl=headerTpl.split('___rank___').join(STATS_LANG[palastStatsLang].RANK);headerTpl=headerTpl.split('___avatar___').join(STATS_LANG[palastStatsLang].AVATAR);headerTpl=headerTpl.split('___name___').join(STATS_LANG[palastStatsLang].NAME);headerTpl=headerTpl.split('___score___').join(STATS_LANG[palastStatsLang].SCORE);headerTpl=headerTpl.split('___roundsPlayed___').join(STATS_LANG[palastStatsLang].ROUNDS_PLAYED);table.append(jQuery(headerTpl));for(var i=0;i<stats.length;++i){var tpl=this.getLeagueStatsTableRowTemplate();tpl=tpl.split('___rank___').join(stats[i].title);tpl=tpl.split('___avatar___').join(stats[i].avatar);tpl=tpl.split('___name___').join(stats[i].nickname);tpl=tpl.split('___score___').join(stats[i].score);tpl=tpl.split('___roundsPlayed___').join(stats[i].rounds);table.append(jQuery(tpl))}}}